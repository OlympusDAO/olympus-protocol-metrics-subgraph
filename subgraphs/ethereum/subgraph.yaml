specVersion: 0.0.8
description: Olympus Protocol Metrics Subgraph
repository: https://github.com/OlympusDAO/olympus-protocol-metrics-subgraph
# features:
#   - grafting
# graft:
#   base: QmSwwBfAoWJLHQeSTagFnkibnkrjeprxcQpXAHk6AVrysA
#   block: 18185779 # Clearinghouse deployment
schema:
  file: ../../schema.graphql
dataSources:
  # #sOHM
  # - kind: ethereum/contract
  #   name: sOlympusERC20V1
  #   network: mainnet
  #   source:
  #     address: "0x31932e6e45012476ba3a3a4953cba62aee77fbbe"
  #     abi: sOlympusERC20
  #     startBlock: 14690000
  #   mapping:
  #     kind: ethereum/events
  #     apiVersion: 0.0.6
  #     language: wasm/assemblyscript
  #     entities:
  #       - sOlympusERC20V1
  #     abis:
  #       - name: OlympusStakingV1
  #         file: ./abis/OlympusStakingV1.json
  #       - name: sOlympusERC20
  #         file: ./abis/sOlympusERC20.json
  #       - name: OlympusERC20
  #         file: ./abis/OlympusERC20.json
  #       # Needed for price lookup
  #       - name: ERC20
  #         file: ../shared/abis/ERC20.json
  #       - name: UniswapV2Pair
  #         file: ../shared/abis/UniswapV2Pair.json
  #       - name: BalancerVault
  #         file: ../shared/abis/BalancerVault.json
  #       - name: BalancerPoolToken
  #         file: ../shared/abis/BalancerPoolToken.json
  #     callHandlers:
  #       - function: rebase(uint256)
  #         handler: rebaseFunction
  #     file: ./src/sOlympus/sOlympusERC20V1.ts
  # - kind: ethereum/contract
  #   name: sOlympusERC20V2
  #   network: mainnet
  #   source:
  #     address: "0x04f2694c8fcee23e8fd0dfea1d4f5bb8c352111f"
  #     abi: sOlympusERC20V2
  #     startBlock: 14690000
  #   mapping:
  #     kind: ethereum/events
  #     apiVersion: 0.0.6
  #     language: wasm/assemblyscript
  #     entities:
  #       - sOlympusERC20V2
  #     abis:
  #       - name: OlympusStakingV2
  #         file: ./abis/OlympusStakingV2.json
  #       - name: sOlympusERC20V2
  #         file: ./abis/sOlympusERC20V2.json
  #       - name: OlympusERC20
  #         file: ./abis/OlympusERC20.json
  #       # Needed for price lookup
  #       - name: ERC20
  #         file: ../shared/abis/ERC20.json
  #       - name: UniswapV2Pair
  #         file: ../shared/abis/UniswapV2Pair.json
  #       - name: BalancerVault
  #         file: ../shared/abis/BalancerVault.json
  #       - name: BalancerPoolToken
  #         file: ../shared/abis/BalancerPoolToken.json
  #     callHandlers:
  #       - function: rebase(uint256,uint256)
  #         handler: rebaseFunction
  #     file: ./src/sOlympus/sOlympusERC20V2.ts
  # - kind: ethereum/contract
  #   name: sOlympusERC20V3
  #   network: mainnet
  #   source:
  #     address: "0x04906695D6D12CF5459975d7C3C03356E4Ccd460"
  #     abi: sOlympusERC20V3
  #     startBlock: 14690000
  #   mapping:
  #     kind: ethereum/events
  #     apiVersion: 0.0.6
  #     language: wasm/assemblyscript
  #     entities:
  #       - sOlympusERC20V3
  #     abis:
  #       - name: OlympusStakingV3
  #         file: ./abis/OlympusStakingV3.json
  #       - name: sOlympusERC20V3
  #         file: ./abis/sOlympusERC20V3.json
  #       - name: OlympusERC20
  #         file: ./abis/OlympusERC20.json
  #       # Needed for price lookup
  #       - name: ERC20
  #         file: ../shared/abis/ERC20.json
  #       - name: UniswapV2Pair
  #         file: ../shared/abis/UniswapV2Pair.json
  #       - name: BalancerVault
  #         file: ../shared/abis/BalancerVault.json
  #       - name: BalancerPoolToken
  #         file: ../shared/abis/BalancerPoolToken.json
  #     callHandlers:
  #       - function: rebase(uint256,uint256)
  #         handler: rebaseFunction
  #     file: ./src/sOlympus/sOlympusERC20V3.ts
  - kind: ethereum/contract
    name: ProtocolMetrics
    network: mainnet
    source:
      # DAI-ETH price feed
      address: "0x158228e08C52F3e2211Ccbc8ec275FA93f6033FC"
      abi: ChainlinkPriceFeed
      startBlock: 14690000
    mapping:
      kind: ethereum/events
      apiVersion: 0.0.6
      language: wasm/assemblyscript
      entities:
        - ProtocolMetric
        - TokenRecord
        - TokenSupply
        - GnosisAuctionRoot
        - GnosisAuction
      abis:
        - name: OlympusStakingV1
          file: ./abis/OlympusStakingV1.json
        - name: OlympusStakingV2
          file: ./abis/OlympusStakingV2.json
        - name: OlympusStakingV3
          file: ./abis/OlympusStakingV3.json
        - name: sOlympusERC20
          file: ./abis/sOlympusERC20.json
        - name: sOlympusERC20V2
          file: ./abis/sOlympusERC20V2.json
        - name: sOlympusERC20V3
          file: ./abis/sOlympusERC20V3.json
        - name: OlympusERC20
          file: ./abis/OlympusERC20.json
        - name: UniswapV2Pair
          file: ../shared/abis/UniswapV2Pair.json
        - name: UniswapV3Pair
          file: ../shared/abis/UniswapV3Pair.json
        - name: CirculatingSupply
          file: ./abis/CirculatingSupply.json
        - name: ERC20
          file: ../shared/abis/ERC20.json
        - name: MasterChef
          file: ./abis/MasterChef.json
        - name: VeFXS
          file: ./abis/VeFXS.json
        - name: RariAllocator
          file: ./abis/RariAllocator.json
        - name: BalancerVault
          file: ../shared/abis/BalancerVault.json
        - name: BalancerPoolToken
          file: ../shared/abis/BalancerPoolToken.json
        - name: ConvexBaseRewardPool
          file: ./abis/ConvexBaseRewardPool.json
        - name: CurvePool
          file: ./abis/CurvePool.json
        - name: CurvePoolV2
          file: ./abis/CurvePoolV2.json
        - name: TokeAllocator
          file: ./abis/TokeAllocator.json
        - name: LUSDAllocatorV2
          file: ./abis/LUSDAllocatorV2.json
        - name: TokemakStaking
          file: ./abis/TokemakStaking.json
        - name: LQTYStaking
          file: ./abis/LQTYStaking.json
        - name: BalancerLiquidityGauge
          file: ./abis/BalancerLiquidityGauge.json
        - name: gOHM
          file: ../shared/abis/gOHM.json
        - name: FraxSwapPool
          file: ./abis/FraxSwapPool.json
        - name: vlCVX
          file: ./abis/vlCVX.json
        - name: AuraStaking
          file: ./abis/AuraStaking.json
        - name: AuraLocker
          file: ./abis/AuraLocker.json
        - name: AuraVirtualBalanceRewardPool
          file: ./abis/AuraVirtualBalanceRewardPool.json
        - name: FraxFarm
          file: ./abis/FraxFarm.json
        - name: MakerDSR
          file: ./abis/MakerDSR.json
        - name: rlBTRFLY
          file: ./abis/rlBTRFLY.json
        - name: ChainlinkPriceFeed
          file: ../shared/abis/ChainlinkPriceFeed.json
        - name: LiquityStabilityPool
          file: ./abis/StabilityPool.json
        - name: ERC4626
          file: ./abis/ERC4626.json
        - name: UniswapV3PositionManager
          file: ./abis/UniswapV3PositionManager.json
        # Gnosis Auctions
        - name: BondManager
          file: ./abis/BondManager.json
        - name: GnosisEasyAuction
          file: ./abis/GnosisEasyAuction.json
        - name: BondFixedExpiryTeller
          file: ./abis/BondFixedExpiryTeller.json
        # Boosted Liquidity Vault
        - name: OlympusBoostedLiquidityRegistry
          file: ./abis/OlympusBoostedLiquidityRegistry.json
        - name: OlympusBoostedLiquidityVaultLido
          file: ./abis/OlympusBoostedLiquidityVaultLido.json
        # IncurDebt
        - name: IncurDebt
          file: ./abis/IncurDebt.json
        # Cooler Loans
        - name: CoolerLoansClearinghouse
          file: ./abis/CoolerLoansClearinghouse.json
      # This will trigger every hour
      # Some Chainlink price feeds will trigger every 24 hours, but that is too infrequent
      eventHandlers:
        - event: NewRound(indexed uint256,indexed address,uint256)
          handler: handleNewRound
      file: ./src/protocolMetrics/ProtocolMetrics.ts
  ###
  # BondManager and GnosisEasyAuction index Gnosis auction events, used for bond calculations
  ###
  - kind: ethereum/contract
    name: BondManager
    network: mainnet
    source:
      address: "0xf577c77ee3578c7f216327f41b5d7221ead2b2a3"
      abi: BondManager
      startBlock: 16226955
    mapping:
      kind: ethereum/events
      apiVersion: 0.0.6
      language: wasm/assemblyscript
      entities:
        - GnosisAuctionRoot
        - GnosisAuction
      abis:
        - name: BondManager
          file: ./abis/BondManager.json
      eventHandlers:
        - event: GnosisAuctionLaunched(uint256,address,uint96,uint48)
          handler: handleGnosisAuctionLaunched
      file: ./src/GnosisAuction.ts
  - kind: ethereum/contract
    name: GnosisEasyAuction
    network: mainnet
    source:
      address: "0x0b7ffc1f4ad541a4ed16b40d8c37f0929158d101"
      abi: GnosisEasyAuction
      startBlock: 16226955 # Same as BondManager
    mapping:
      kind: ethereum/events
      apiVersion: 0.0.6
      language: wasm/assemblyscript
      entities:
        - GnosisAuction
      abis:
        - name: GnosisEasyAuction
          file: ./abis/GnosisEasyAuction.json
      eventHandlers:
        - event: AuctionCleared(indexed uint256,uint96,uint96,bytes32)
          handler: handleGnosisAuctionCleared
      file: ./src/GnosisAuction.ts